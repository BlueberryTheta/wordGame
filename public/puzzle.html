<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inqaily — Puzzle</title>
    <script>
      (function(){ try { if (localStorage.getItem('theme') === 'light') document.documentElement.classList.add('theme-light'); } catch {} })();
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2757226819137152" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/light.css" />
  </head>
  <body>
    <div class="app">
      <div class="titlebar">
        <div class="title-main">
          <h1 class="site-title">Inqaily</h1>
          <div class="subtitle">Puzzle Mode</div>
        </div>
        <div class="title-actions">
          <button id="helpBtn" class="help-btn" title="How to play" aria-label="How to play" data-tip="How to play" aria-haspopup="dialog" aria-controls="tutorialBackdrop">?</button>
          <button id="themeToggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">☀</button>
          <div class="menu-mount">
            <button id="menuToggle" class="menu-toggle" aria-label="Menu" aria-expanded="false" aria-haspopup="true" aria-controls="menuDropdown" title="Menu">☰</button>
            <div id="menuDropdown" class="menu-dropdown hidden" role="menu" aria-hidden="true">
              <a href="/" role="menuitem">Daily</a>
              <a href="/vault.html" role="menuitem">Vault</a>
            </div>
          </div>
        </div>
      </div>

      <div class="meta">
        <div>Day: <span id="pDayKey">—</span></div>
        <div>Letters: <span id="pWordLength">—</span></div>
      </div>

      <section class="panel">
        <div id="pTiles" class="tiles" aria-live="polite"></div>
      </section>
      <section class="panel">
        <h2>Hints</h2>
        <div id="pHints" class="qa"></div>
      </section>
      <section class="panel">
        <h2>Your One Guess</h2>
        <div class="row">
          <input id="pGuess" type="text" placeholder="Your guess" />
          <button id="pGuessBtn">Guess</button>
        </div>
        <div id="pResult" class="muted" style="margin-top:8px"></div>
      </section>

      <footer>
        <small>New word rolls at 12:01 AM Eastern Time.</small>
        <nav class="legal-links" aria-label="Legal and Privacy">
          <a href="/privacy.html">Privacy</a>
          <span class="sep">•</span>
          <a href="/terms.html">Terms</a>
          <span class="sep">•</span>
          <a href="/cookies.html">Cookies</a>
        </nav>
      </footer>
    </div>

    <script type="module">
      const els = {
        tiles: document.getElementById('pTiles'),
        hints: document.getElementById('pHints'),
        input: document.getElementById('pGuess'),
        btn: document.getElementById('pGuessBtn'),
        res: document.getElementById('pResult'),
        dayKeyEl: document.getElementById('pDayKey'),
        wordLenEl: document.getElementById('pWordLength')
      };
      // Simple per-day storage so game-over persists across refreshes
      function storageKey(day){ return `wotd:puzzle:${day}`; }
      function loadState(day){ try { const raw = localStorage.getItem(storageKey(day)); return raw ? JSON.parse(raw) : null; } catch { return null; } }
      function saveState(day, obj){ try { localStorage.setItem(storageKey(day), JSON.stringify(obj)); } catch {}
      }
      let mask = [];
      let len = 0;
      let used = false;

      function renderTiles(){
        els.tiles.innerHTML = '';
        for (let i=0;i<len;i++){
          const s = document.createElement('span');
          s.className = 'tile' + (mask[i] ? '' : ' empty');
          s.textContent = mask[i] ? mask[i].toUpperCase() : '·';
          els.tiles.appendChild(s);
        }
      }
      function renderHints(qas){
        els.hints.innerHTML = '';
        qas.forEach(({q,a}) => {
          const div = document.createElement('div');
          div.className = 'item';
          const qel = document.createElement('div'); qel.className = 'q'; qel.textContent = `Q: ${q}`;
          const ael = document.createElement('div'); ael.className = 'a'; ael.textContent = `A: ${a}`;
          div.appendChild(qel); div.appendChild(ael);
          els.hints.appendChild(div);
        });
      }

      async function load(){
        try{
          const r = await fetch('/api/puzzle/state');
          if (!r.ok) throw new Error('Puzzle unavailable');
          const j = await r.json();
          len = j.wordLength;
          mask = j.revealedMask || Array(len).fill(null);
          if (els.dayKeyEl) els.dayKeyEl.textContent = formatDay(j.dayKey || '');
          if (els.wordLenEl) els.wordLenEl.textContent = String(len);
          renderTiles();
          renderHints(j.qas || []);
          // If user already played today, reopen modal and lock inputs
          const st = loadState(j.dayKey || '');
          if (st && st.used) {
            els.btn.disabled = true; els.input.disabled = true;
            if (st.win) {
              openGameOver('You got it!', 'Great job! Come back tomorrow for a new puzzle.', true);
            } else {
              const baseTxt = st.letters ? `Letters in common: ${st.letters}` : 'No letters in common.';
              const msg = st.word ? `${baseTxt} The word was ${String(st.word).toUpperCase()}.` : baseTxt;
              openGameOver('Out of guesses', msg);
            }
          }
        } catch(e){
          els.tiles.innerHTML = '';
          els.hints.innerHTML = '';
          const msg = document.createElement('div');
          msg.className = 'muted';
          msg.textContent = 'Puzzle mode is unavailable right now. Please try again later.';
          els.hints.appendChild(msg);
        }
      }

      async function doGuess(){
        if (used) return;
        const g = (els.input.value||'').trim();
        if (!g) return;
        els.btn.disabled = true; used = true;
        try{
          const r = await fetch('/api/puzzle/guess', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ guess: g }) });
          const j = await r.json();
          if (!r.ok) throw new Error(j.error||'failed');
          if (j.correct){
            els.res.innerHTML = `<span class="ok">Correct!</span>`;
            openGameOver('You got it!', 'Great job! Come back tomorrow for a new puzzle.', true, j.word);
            try { startConfetti(); } catch {}
            // Persist win
            try { const day = (els.dayKeyEl?.textContent || '').trim(); if (day) saveState(dayFromPretty(day), { used:true, win:true }); } catch {}
          } else {
            mask = j.revealedMask || mask;
            renderTiles();
            const letters = (j.lettersInCommon||[]).map(x=>x.toUpperCase()).join(', ');
            const baseTxt = letters ? `Letters in common: ${letters}` : `No letters in common.`;
            try{
              const rr = await fetch('/api/puzzle/reveal');
              const jj = await rr.json();
              const w = String(jj.word||'').toUpperCase();
              openGameOver('Out of guesses', `${baseTxt} The word was ${w}.`);
              try { const day = (els.dayKeyEl?.textContent || '').trim(); if (day) saveState(dayFromPretty(day), { used:true, win:false, letters, word:w }); } catch {}
            } catch {
              openGameOver('Out of guesses', baseTxt);
              try { const day = (els.dayKeyEl?.textContent || '').trim(); if (day) saveState(dayFromPretty(day), { used:true, win:false, letters }); } catch {}
            }
          }
        } catch(e){ els.res.textContent = 'Error: ' + (e?.message||''); }
        finally { els.btn.disabled = true; els.input.disabled = true; }
      }
      els.btn.addEventListener('click', doGuess);
      els.input.addEventListener('keydown', e => { if (e.key==='Enter') doGuess(); });
      load();

      // Theme
      function applyTheme(theme){
        const root = document.documentElement;
        if (theme === 'light') root.classList.add('theme-light'); else root.classList.remove('theme-light');
        try { localStorage.setItem('theme', theme); } catch {}
        const t = document.getElementById('themeToggle');
        if (t) { t.setAttribute('aria-label', theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode'); t.textContent = theme === 'light' ? '\u263E' : '\u2600'; }
      }
      (function setupTheme(){ let theme='dark'; try { theme = localStorage.getItem('theme') || theme; } catch {} applyTheme(theme); const t=document.getElementById('themeToggle'); t?.addEventListener('click', ()=>{ const next=(localStorage.getItem('theme')||'dark')==='light'?'dark':'light'; applyTheme(next); }); })();

      // Menu
      (function setupMenu(){ const btn=document.getElementById('menuToggle'); const dd=document.getElementById('menuDropdown'); if(!btn||!dd) return; function close(){ dd.classList.add('hidden'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); document.removeEventListener('click',onDoc); document.removeEventListener('keydown',onEsc);} function onDoc(e){ if(e.target===btn||btn.contains(e.target)||e.target===dd||dd.contains(e.target)) return; close(); } function onEsc(e){ if(e.key==='Escape') close(); } btn.addEventListener('click', (e)=>{ e.stopPropagation(); const hidden=dd.classList.contains('hidden'); if(hidden){ dd.classList.remove('hidden'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); setTimeout(()=>{ document.addEventListener('click',onDoc); document.addEventListener('keydown',onEsc); },0);} else close(); }); })();

      // Tutorial auto-open (share key with main)
      (function(){ try { if (!localStorage.getItem('tutorialSeen')) setTimeout(()=>document.getElementById('helpBtn')?.click(), 250); } catch { setTimeout(()=>document.getElementById('helpBtn')?.click(), 250); } })();

      function formatDay(key){ try { const [y,m,d]=String(key).split('-').map(n=>parseInt(n,10)); if(!y||!m||!d) return String(key||''); const dt=new Date(Date.UTC(y,m-1,d,12)); const parts=new Intl.DateTimeFormat('en-US',{ timeZone:'America/New_York', weekday:'short', month:'short', day:'numeric' }).formatToParts(dt); const mp=Object.fromEntries(parts.map(p=>[p.type,p.value])); return `${mp.weekday||''} · ${mp.month||''} ${mp.day||''}`.trim(); } catch { return String(key||''); } }
      // Convert pretty day back to key (YYYY-MM-DD) using ET to match server key
      function dayFromPretty(pretty){
        try{
          // pretty like: Tue · Sep 23 (no year). Use today’s year for key fallback.
          const parts = pretty.split('·')[1]?.trim().split(' ') || [];
          if (parts.length < 2) return '';
          const month = parts[0]; const day = parseInt(parts[1],10);
          const mIdx = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].indexOf(month);
          if (mIdx < 0 || isNaN(day)) return '';
          const tz='America/New_York'; const now=new Date();
          const y = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric' }).format(now);
          return `${y}-${String(mIdx+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        } catch { return ''; }
      }

      function openGameOver(title, message, win=false, word=''){
        const b=document.getElementById('pGameOver'); if(!b) return; const t=document.getElementById('pGoTitle'); const m=document.getElementById('pGoMessage'); if(t) t.textContent=title; if(m) m.textContent=message; const actions=document.getElementById('pGoActions'); if(win) actions?.classList.remove('hidden'); else actions?.classList.add('hidden'); const shareBtn=document.getElementById('pShare'); if(win&&shareBtn){ shareBtn.onclick=()=>sharePuzzleWin(word); } b.classList.remove('hidden'); function close(){ b.classList.add('hidden'); document.removeEventListener('keydown',onEsc);} function onEsc(e){ if(e.key==='Escape') close(); } document.getElementById('pGoClose')?.addEventListener('click', close, { once:true }); b.addEventListener('click', (e)=>{ if(e.target===b) close(); }); document.addEventListener('keydown', onEsc); }

      async function sharePuzzleWin(word){ const text = `Inqaily — Puzzle: I solved it!\n#Inqaily`; const shareData = { text, title: 'Inqaily — Puzzle' }; try { if (navigator.share) { await navigator.share(shareData); return; } } catch {} try { await navigator.clipboard.writeText(text); } catch {} }
    </script>

    <!-- Tutorial Modal -->
    <div id="tutorialBackdrop" class="backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="tutorialTitle">How to Play (Puzzle)</h2>
          <button id="closeTutorial" class="close-btn" aria-label="Close tutorial">×</button>
        </div>
        <div class="modal-body">
          <ul>
            <li>You get 1 total guess.</li>
            <li>We reveal 1-2 letters of the word up front.</li>
            <li>Six to seven brief AI hints give general context.</li>
            <li>The word is always a noun.</li>
          </ul>
        </div>
      </div>
    </div>
    <script>
      (function(){ const helpBtn=document.getElementById('helpBtn'); const back=document.getElementById('tutorialBackdrop'); const closeBtn=document.getElementById('closeTutorial'); function show(){ if(back) back.classList.remove('hidden'); document.addEventListener('keydown', onEsc);} function hide(){ if(back) back.classList.add('hidden'); document.removeEventListener('keydown', onEsc);} function onEsc(e){ if(e.key==='Escape') hide(); } helpBtn?.addEventListener('click', show); closeBtn?.addEventListener('click', hide); back?.addEventListener('click', (e)=>{ if(e.target===back) hide(); }); })();
    </script>

    <!-- Game Over Modal for Puzzle -->
    <div id="pGameOver" class="backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="pGoTitle">
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="pGoTitle">Game Over</h2>
          <button id="pGoClose" class="close-btn" aria-label="Close">×</button>
        </div>
        <div class="modal-body" style="text-align:center">
          <p id="pGoMessage">Thanks for playing! Come back tomorrow for a new puzzle.</p>
          <div id="pGoActions" class="score-actions hidden">
            <button id="pShare" class="share-btn" aria-label="Share your win">Share</button>
          </div>
          <div class="mode-explore" style="margin-top:12px">
            <p style="margin:8px 0; color: var(--muted)">Want more? Try another mode:</p>
            <div class="mode-actions" style="display:flex; gap:8px; justify-content:center">
              <a class="share-btn" href="/" aria-label="Play Daily mode">Play Daily</a>
              <a class="share-btn" href="/vault.html" aria-label="Explore Vault">Open Vault</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Confetti effect (same as main)
      function startConfetti(duration = 1500, count = 140) {
        const canvas = document.createElement('canvas');
        Object.assign(canvas.style, { position: 'fixed', inset: 0, width: '100%', height: '100%', pointerEvents: 'none', zIndex: 2000 });
        document.body.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        function resize() { canvas.width = innerWidth * dpr; canvas.height = innerHeight * dpr; }
        resize();
        const colors = ['#78d9ff', '#6dd16a', '#e9ecf1', '#a7b0c3', '#ff6b6b'];
        const parts = Array.from({ length: count }, () => ({
          x: Math.random() * canvas.width,
          y: -Math.random() * canvas.height * 0.5,
          w: 6 + Math.random() * 6,
          h: 10 + Math.random() * 10,
          vx: (-0.5 + Math.random()) * 1.2 * dpr,
          vy: (1 + Math.random() * 2.5) * dpr,
          rot: Math.random() * Math.PI,
          vr: (-0.5 + Math.random()) * 0.2,
          color: colors[Math.floor(Math.random() * colors.length)]
        }));
        const start = performance.now();
        let raf;
        function tick(t) {
          const elapsed = t - start;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          parts.forEach(p => {
            p.x += p.vx; p.y += p.vy; p.rot += p.vr;
            if (p.y > canvas.height) { p.y = -10; p.x = Math.random() * canvas.width; }
            ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot); ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
          });
          if (elapsed < duration) raf = requestAnimationFrame(tick); else cleanup();
        }
        function cleanup() { cancelAnimationFrame(raf); canvas.remove(); }
        window.addEventListener('resize', resize, { once: true });
        raf = requestAnimationFrame(tick);
      }
    </script>
  </body>
  </html>

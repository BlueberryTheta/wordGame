<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inqaily ‚Äî Puzzle</title>
    <script>
      (function(){
        try { if (localStorage.getItem('theme') === 'light') document.documentElement.classList.add('theme-light'); } catch {}
      })();
    </script>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/light.css" />
    <style>
      .page{max-width:800px; margin:32px auto; padding:0 16px}
      .panel{background:var(--card); border:1px solid var(--shade); border-radius:12px; padding:16px; margin:16px 0}
      .tiles{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap}
      .tile{width:44px; height:54px; display:flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid var(--shade); background:linear-gradient(180deg,#0f142c,#0b0e1d); font:700 22px var(--mono); letter-spacing:.5px; color:var(--fg); box-shadow:inset 0 -3px 0 rgba(255,255,255,.03)}
      .tile.empty{color:var(--muted); opacity:.85}
      .qa{display:flex; flex-direction:column; gap:8px}
      .qa .item{background:#0e1120; border:1px solid var(--shade); padding:10px 12px; border-radius:8px}
      .qa .q{color:#b8c2d9}
      .qa .a{color:#dff1ff}
      .muted{color:var(--muted)}
    </style>
  </head>
  <body>
    <div class="page">
      <div class="titlebar" style="margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; gap:12px">
        <div class="title-main"><h1 style="margin:0">Puzzle Mode</h1></div>
        <div class="title-actions" style="display:flex; align-items:center; gap:8px">
          <button id="helpBtn" class="help-btn" title="How to play" aria-label="How to play" data-tip="How to play" aria-haspopup="dialog" aria-controls="tutorialBackdrop">?</button>
          <button id="themeToggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">?</button>
          <div class="menu-mount">
            <button id="menuToggle" class="menu-toggle" aria-label="Menu" aria-expanded="false" aria-haspopup="true" aria-controls="menuDropdown" title="Menu">‚ò∞</button>
            <div id="menuDropdown" class="menu-dropdown hidden" role="menu" aria-hidden="true">
              <a href="/" role="menuitem">Home</a>
              <a href="/vault.html" role="menuitem">Vault</a>
            </div>
          </div>
        </div>
      </div>
      <div class="meta">
        <div>Day: <span id="pDayKey">‚Äî</span></div>
        <div>Letters: <span id="pWordLength">‚Äî</span></div>
      </div>
      <div class="panel">
        <div id="pTiles" class="tiles" aria-live="polite"></div>
      </div>
      <div class="panel">
        <h2>Hints</h2>
        <div id="pHints" class="qa"></div>
      </div>
      <div class="panel">
        <h2>Your One Guess</h2>
        <div class="row">
          <input id="pGuess" type="text" placeholder="Your guess" />
          <button id="pGuessBtn">Guess</button>
        </div>
        <div id="pResult" class="muted" style="margin-top:8px"></div>
      </div>
      <p><a href="/">‚Üê Back to Inqaily</a></p>
    </div>
    <script type="module">
      const els = {
        tiles: document.getElementById('pTiles'),
        hints: document.getElementById('pHints'),
        input: document.getElementById('pGuess'),
        btn: document.getElementById('pGuessBtn'),
        res: document.getElementById('pResult'),
        dayKeyEl: document.getElementById('pDayKey'),
        wordLenEl: document.getElementById('pWordLength')
      };
      let mask = [];
      let len = 0;
      let used = false;
      function renderTiles(){
        els.tiles.innerHTML = '';
        for (let i=0;i<len;i++){
          const s = document.createElement('span');
          s.className = 'tile' + (mask[i] ? '' : ' empty');
          s.textContent = mask[i] ? mask[i].toUpperCase() : '¬∑';
          els.tiles.appendChild(s);
        }
      }
      function renderHints(qas){
        els.hints.innerHTML = '';
        qas.forEach(({q,a}) => {
          const div = document.createElement('div');
          div.className = 'item';
          const qel = document.createElement('div'); qel.className = 'q'; qel.textContent = `Q: ${q}`;
          const ael = document.createElement('div'); ael.className = 'a'; ael.textContent = `A: ${a}`;
          div.appendChild(qel); div.appendChild(ael);
          els.hints.appendChild(div);
        });
      }
      async function load(){
        const r = await fetch('/api/puzzle/state');
        const j = await r.json();
        len = j.wordLength;
        mask = j.revealedMask || Array(len).fill(null);
        if (els.dayKeyEl) els.dayKeyEl.textContent = formatDay(j.dayKey || '');
        if (els.wordLenEl) els.wordLenEl.textContent = String(len);
        renderTiles();
        renderHints(j.qas || []);
      }
      async function doGuess(){
        if (used) return;
        const g = (els.input.value||'').trim();
        if (!g) return;
        els.btn.disabled = true; used = true;
        try{
          const r = await fetch('/api/puzzle/guess', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ guess: g }) });
          const j = await r.json();
          if (!r.ok) throw new Error(j.error||'failed');
          if (j.correct){
            els.res.innerHTML = `<span style="color:#6dd16a">Correct! The word was ${j.word.toUpperCase()}.</span>`;
            openGameOver('You got it!', 'Great job! Come back tomorrow for a new puzzle.', true, j.word);
          } else {
            mask = j.revealedMask || mask;
            renderTiles();
            const letters = (j.lettersInCommon||[]).map(x=>x.toUpperCase()).join(', ');
            els.res.innerHTML = letters ? `Letters in common: <b>${letters}</b>` : `<span style=\"color:#ff6b6b\">No letters in common.</span>`;
            // Reveal the word after the single guess
            try{ const rr = await fetch('/api/puzzle/reveal'); const jj = await rr.json(); openGameOver('Out of guesses', `${letters ? `Letters in common: ${letters}. ` : ''}The word was ${String(jj.word||'').toUpperCase()}.`); } catch {}
          }
        } catch(e){ els.res.textContent = 'Error: ' + (e?.message||''); }
        finally { els.btn.disabled = true; els.input.disabled = true; }
      }
      els.btn.addEventListener('click', doGuess);
      els.input.addEventListener('keydown', e => { if (e.key==='Enter') doGuess(); });
      load();

      // ---- Shared UI bits: theme toggle, menu, tutorial ----
      function applyTheme(theme){
        const root = document.documentElement;
        if (theme === 'light') root.classList.add('theme-light');
        else root.classList.remove('theme-light');
        try { localStorage.setItem('theme', theme); } catch {}
        const t = document.getElementById('themeToggle');
        if (t) {
          t.setAttribute('aria-label', theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode');
          // Match main page button text
          t.textContent = theme === 'light' ? '\u263E' : '\u2600';
        }
      }
      (function setupTheme(){
        let theme = 'dark';
        try {
          theme = localStorage.getItem('theme') || theme;
        } catch {}
        applyTheme(theme);
        const t = document.getElementById('themeToggle');
        if (t) t.addEventListener('click', ()=>{
          const next = (localStorage.getItem('theme') || 'dark') === 'light' ? 'dark' : 'light';
          applyTheme(next);
        });
      })();

      (function setupMenu(){
        const btn = document.getElementById('menuToggle');
        const dd = document.getElementById('menuDropdown');
        if (!btn || !dd) return;
        function close(){
          dd.classList.add('hidden');
          btn.setAttribute('aria-expanded','false');
          dd.setAttribute('aria-hidden','true');
          document.removeEventListener('click', onDoc);
          document.removeEventListener('keydown', onEsc);
        }
        function onDoc(e){ if (e.target===btn||btn.contains(e.target)||e.target===dd||dd.contains(e.target)) return; close(); }
        function onEsc(e){ if (e.key==='Escape') close(); }
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const hidden = dd.classList.contains('hidden');
          if (hidden){
            dd.classList.remove('hidden');
            btn.setAttribute('aria-expanded','true');
            dd.setAttribute('aria-hidden','false');
            setTimeout(()=>{ document.addEventListener('click', onDoc); document.addEventListener('keydown', onEsc); },0);
          } else close();
        });
      })();

      // Auto-open tutorial on first visit (shared key with main)
      (function maybeShowTutorial(){
        try { if (!localStorage.getItem('tutorialSeen')) setTimeout(()=>document.getElementById('helpBtn')?.click(), 250); }
        catch { setTimeout(()=>document.getElementById('helpBtn')?.click(), 250); }
      })();

      function formatDay(key){
        try {
          const [y,m,d] = String(key).split('-').map(n=>parseInt(n,10));
          if (!y||!m||!d) return String(key||'');
          const dt = new Date(Date.UTC(y, m-1,  d, 12));
          const parts = new Intl.DateTimeFormat('en-US', { timeZone: 'America/New_York', weekday:'short', month:'short', day:'numeric' }).formatToParts(dt);
          const mp = Object.fromEntries(parts.map(p=>[p.type,p.value]));
          return `${mp.weekday||''} ¬∑ ${mp.month||''} ${mp.day||''}`.trim();
        } catch { return String(key||''); }
      }

      function openGameOver(title, message, win=false, word=''){
        const b = document.getElementById('pGameOver');
        if (!b) return;
        const t = document.getElementById('pGoTitle');
        const m = document.getElementById('pGoMessage');
        if (t) t.textContent = title;
        if (m) m.textContent = message;
        const actions = document.getElementById('pGoActions');
        if (win) actions?.classList.remove('hidden'); else actions?.classList.add('hidden');
        const shareBtn = document.getElementById('pShare');
        if (win && shareBtn) { shareBtn.onclick = () => sharePuzzleWin(word); }
        b.classList.remove('hidden');
        function close(){ b.classList.add('hidden'); document.removeEventListener('keydown', onEsc); }
        function onEsc(e){ if (e.key==='Escape') close(); }
        document.getElementById('pGoClose')?.addEventListener('click', close, { once:true });
        b.addEventListener('click', (e)=>{ if (e.target===b) close(); });
        document.addEventListener('keydown', onEsc);
      }

      async function sharePuzzleWin(word){
        const text = `Inqaily ‚Äî Puzzle: I solved it!\nWord: ${String(word||'').toUpperCase()}\n#Inqaily`;
        const shareData = { text, title: 'Inqaily ‚Äî Puzzle' };
        try { if (navigator.share) { await navigator.share(shareData); return; } } catch {}
        try { await navigator.clipboard.writeText(text); } catch {}
      }
    </script>

    <!-- Tutorial Modal (reused) -->
    <div id="tutorialBackdrop" class="backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="tutorialTitle">How to Play (Puzzle)</h2>
          <button id="closeTutorial" class="close-btn" aria-label="Close tutorial">√ó</button>
        </div>
        <div class="modal-body">
          <ul>
            <li>You get 1 total guess.</li>
            <li>We reveal 1ñ2 letters of the word up front.</li>
            <li>Six to seven brief AI hints give general context.</li>
            <li>The word is always a noun.</li>
          </ul>
        </div>
      </div>
    </div>
    <script>
      (function(){
        const helpBtn = document.getElementById('helpBtn');
        const back = document.getElementById('tutorialBackdrop');
        const closeBtn = document.getElementById('closeTutorial');
        function show(){ if (back) back.classList.remove('hidden'); document.addEventListener('keydown', onEsc); }
        function hide(){ if (back) back.classList.add('hidden'); document.removeEventListener('keydown', onEsc); }
        function onEsc(e){ if (e.key==='Escape') hide(); }
        helpBtn?.addEventListener('click', show);
        closeBtn?.addEventListener('click', hide);
        back?.addEventListener('click', (e)=>{ if (e.target===back) hide(); });
      })();
    </script>

    <!-- Game Over Modal for Puzzle -->
    <div id="pGameOver" class="backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="pGoTitle">
      <div class="modal" role="document">
        <div class="modal-header">
          <h2 id="pGoTitle">Game Over</h2>
          <button id="pGoClose" class="close-btn" aria-label="Close">√ó</button>
        </div>
        <div class="modal-body" style="text-align:center">
          <p id="pGoMessage">Thanks for playing! Come back tomorrow for a new puzzle.</p>
          <div id="pGoActions" class="score-actions hidden">
            <button id="pShare" class="share-btn" aria-label="Share your win">Share</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  </html>
